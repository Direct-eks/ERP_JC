<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jc.backend.dao.FeesMapper">

    <resultMap id="categoryResultMap" type="org.jc.backend.entity.FeeCategoryO">
        <result property="feeCategoryID" column="fee_category_id"/>
        <result property="name" column="name"/>
        <result property="remark" column="remark"/>
        <result property="classification" column="classification"/>
        <result property="treeLevel" column="tree_level"/>
    </resultMap>

    <select id="queryAllCategories" resultMap="categoryResultMap">
        select fee_category_id, name, remark, classification, tree_level
        from f_fee_category
    </select>

    <insert id="insertCategory">
        insert into f_fee_category (name, remark, classification, tree_level)
        values (#{name}, #{remark}, #{classification}, #{treeLevel})
    </insert>

    <update id="updateCategory">
        update f_fee_category
        set name = #{name},
            remark = #{remark},
            classification = #{classification},
            tree_level = #{treeLevel}
        where fee_category_id = #{feeCategoryID}
    </update>

    <delete id="deleteCategory">
        delete from f_fee_category
        where fee_category_id = #{id}
    </delete>


    <select id="countNumberOfEntriesOfGivenDate" resultType="java.lang.Integer">
        select count(fee_entry_id)
        from f_fee_entry
        where entry_date = #{date} and fee_entry_id like #{prefix}||'%'
    </select>

    <insert id="insertNewEntry">
        insert into f_fee_entry(
            fee_entry_id, entry_date, creation_date, drawer, source_account_id, destination_account_id,
            amount, number, department_id, indication, remark, is_book_keeping, is_verified
        )
        values (
            #{feeEntryID}, #{entryDate}, date('now', 'localtime'), #{drawer}, #{sourceAccountID},
            #{destinationAccountID}, #{amount}, #{number}, #{departmentID}, '', #{remark},
            #{isBookKeeping}, #{isVerified}
        )
    </insert>

    <insert id="insertNewDetail" useGeneratedKeys="true" keyProperty="feeDetailEntryID"
            keyColumn="fee_detail_entry_id">
        insert into f_fee_detail_entry(fee_entry_id, fee_category_id, remark, amount)
        values (#{feeEntryID}, #{feeCategoryID}, #{remark}, #{amount})
    </insert>

    <resultMap id="entryResultMap" type="org.jc.backend.entity.DO.FeeEntryDO">
        <result property="feeEntryID" column="fee_entry_id"/>
        <result property="entryDate" column="entry_date"/>
        <result property="creationDate" column="creation_date"/>
        <result property="drawer" column="drawer"/>
        <result property="sourceAccountID" column="source_account_id"/>
        <result property="sourceAccountName" column="source_name"/>
        <result property="destinationAccountID" column="destination_account_id"/>
        <result property="destinationAccountName" column="dest_name"/>
        <result property="amount" column="amount"/>
        <result property="number" column="number"/>
        <result property="remark" column="remark"/>
        <result property="departmentID" column="department_id"/>
        <result property="departmentName" column="department_name"/>
        <result property="remark" column="remark"/>
        <result property="isBookKeeping" column="is_book_keeping"/>
        <result property="isVerified" column="is_verified"/>
    </resultMap>

    <resultMap id="detailResultMap" type="org.jc.backend.entity.FeeEntryDetailO">
        <result property="feeDetailEntryID" column="fee_detail_entry_id"/>
        <result property="feeEntryID" column="fee_entry_id"/>
        <result property="feeCategoryID" column="fee_category_id"/>
        <result property="feeCategoryName" column="category_name"/>
        <result property="remark" column="remark"/>
        <result property="amount" column="amount"/>
    </resultMap>

    <select id="queryEntriesInDateRange" resultMap="entryResultMap">
        select e.fee_entry_id, e.entry_date, e.creation_date, e.drawer, e.source_account_id,
               b1.name as source_name, e.destination_account_id, b2.name as dest_name,
               e.amount, e.number, e.department_id, d.name as department_name, e.indication,
               e.remark, e.is_book_keeping, e.is_verified
        from f_fee_entry as e join e_department as d on e.department_id = d.department_id
            left join f_bank_account as b1 on e.source_account_id = b1.bank_account_id
            left join f_bank_account as b2 on e.destination_account_id = b1.bank_account_id
        where (e.entry_date between #{startDate} and #{endDate})
            and fee_entry_id like #{prefix}||'%'
        order by fee_entry_id desc
    </select>

    <select id="queryDetailsByEntryID" resultMap="detailResultMap">
        select fee_detail_entry_id, fee_entry_id, e.fee_category_id, c.name as category_name,
               e.remark, amount, e.remark
        from f_fee_detail_entry as e
            join f_fee_category as c on e.fee_category_id = c.fee_category_id
        where fee_entry_id = #{id}
        order by fee_detail_entry_id
    </select>

    <select id="selectEntryForCompare" resultMap="entryResultMap">
        select e.fee_entry_id, e.entry_date, e.creation_date, e.drawer, e.source_account_id,
               b1.name as source_name, e.destination_account_id, b2.name as dest_name,
               e.amount, e.number, e.department_id, d.name as department_name, e.indication,
               e.remark, e.is_book_keeping, e.is_verified
        from f_fee_entry as e join e_department as d on e.department_id = d.department_id
                              left join f_bank_account as b1 on e.source_account_id = b1.bank_account_id
                              left join f_bank_account as b2 on e.destination_account_id = b1.bank_account_id
        where fee_entry_id = #{id}
    </select>

    <update id="updateEntry">
        update f_fee_entry
        set amount = #{amount},
            number = #{number},
            department_id = #{departmentID},
            remark = #{remark},
            is_book_keeping = #{isBookKeeping},
            is_verified = #{isVerified}
        where fee_entry_id = #{feeEntryID}
    </update>

    <update id="updateEntryDetail">
        update f_fee_detail_entry
        set remark = #{remark},
            amount = #{amount}
        where fee_detail_entry_id = #{feeDetailEntryID}
    </update>

</mapper>